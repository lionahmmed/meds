<!DOCTYPE html>
<html>
<head>
  <title>Medicine Scheduler Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    label, input, select, button { font-size: 16px; margin: 5px 0; }
    input, select { padding: 6px; width: 250px; }
    button { padding: 8px 16px; margin-right: 5px; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; font-size: 15px; text-align: center; }
    th { background-color: #f0f0f0; }
    #searchInput { margin-top: 20px; padding: 8px; width: 300px; font-size: 16px; }
    .pagination button { margin: 2px; padding: 4px 10px; }
    .actions button { padding: 5px 10px; font-size: 12px; }
    #status { margin-top: 10px; font-weight: bold; color: green; }
  </style>
</head>
<body>

<h2>Medicine Scheduler Dashboard</h2>

<!-- Uploader Form -->
<label>Person Name:</label><br>
<input type="text" id="person"><br>
<label>Medicine:</label><br>
<input type="text" id="medicine"><br>
<label>Schedule Time:</label><br>
<input type="datetime-local" id="schedule"><br>
<button onclick="sendSchedule()">‚ûï Submit Schedule</button>
<span id="status"></span>

<hr>

<!-- Controls -->
<input type="text" id="searchInput" onkeyup="filterTable()" placeholder="üîç Search...">
<button onclick="exportExcel()">üì• Export to Excel</button>
<button onclick="loadSchedule()">üîÑ Refresh</button>
<br><br>
<label>Auto-refresh (sec): </label><input type="number" id="refreshTime" value="60" onchange="restartAutoRefresh()" style="width:60px">

<!-- Table -->
<table id="dataTable">
  <thead>
    <tr>
      <th>Schedule Time</th>
      <th>Person Name</th>
      <th>Medicine</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="scheduleTable"></tbody>
</table>

<script>
const channelID = '3008675';
const apiKey = 'ALB6HK9T805Q8WJQ';
const readAPIKey = 'FKJ1TPALPIP7H9S8'; // Optional if private
let fullData = [], timer;

// ===== TLV + ASCII Encoding =====
function asciiEncode(str) {
  return Array.from(str).map(c => {
    const code = c.charCodeAt(0);
    return code < 100 ? ('0' + code).slice(-2) : '' + code;
  }).join('');
}
function asciiDecode(str) {
  let result = '', i = 0;
  while (i < str.length) {
    const sub = str.slice(i, i + 3);
    const ch = String.fromCharCode(parseInt(sub));
    result += ch;
    i += 3;
  }
  return result;
}
function toTLV(epoch, name, med) {
  const t1 = `T01L${epoch.toString().length}V${epoch}`;
  const t2 = `T02L${asciiEncode(name).length}V${asciiEncode(name)}`;
  const t3 = `T03L${asciiEncode(med).length}V${asciiEncode(med)}`;
  return t1 + t2 + t3;
}
function parseTLV(tlv) {
  let i = 0, data = {};
  while (i < tlv.length) {
    const tag = tlv.slice(i, i + 3); i += 3;
    const lenEnd = tlv.indexOf('V', i);
    const len = parseInt(tlv.slice(i + 1, lenEnd));
    i = lenEnd + 1;
    const value = tlv.slice(i, i + len); i += len;
    if (tag === 'T01') data.epoch = value;
    else if (tag === 'T02') data.person = asciiDecode(value);
    else if (tag === 'T03') data.medicine = asciiDecode(value);
  }
  return data;
}

// ===== Form Submission =====
function sendSchedule() {
  const person = document.getElementById('person').value.trim();
  const medicine = document.getElementById('medicine').value.trim();
  const scheduleInput = document.getElementById('schedule').value;
  const status = document.getElementById('status');

  if (!person || !medicine || !scheduleInput) {
    status.textContent = "‚ùå Fill all fields!";
    return;
  }

  const epoch = Math.floor(new Date(scheduleInput).getTime() / 1000);
  const tlv = toTLV(epoch, person, medicine);
  const url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=${encodeURIComponent(tlv)}`;

  fetch(url)
    .then(res => res.text())
    .then(data => {
      if (parseInt(data) > 0) {
        status.textContent = "‚úÖ Uploaded! ID: " + data;
        document.getElementById('person').value = '';
        document.getElementById('medicine').value = '';
        document.getElementById('schedule').value = '';
        loadSchedule();
      } else {
        status.textContent = "‚ùå Upload failed!";
      }
    });
}

// ===== Load + Display Schedule =====
function loadSchedule() {
  const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?results=100${readAPIKey ? '&api_key=' + readAPIKey : ''}`;
  fetch(url).then(r => r.json()).then(json => {
    fullData = json.feeds.reverse().map((f, i) => {
      const parsed = parseTLV(f.field1 || '');
      return {
        time: new Date(+parsed.epoch * 1000).toLocaleString(),
        person: parsed.person || '',
        medicine: parsed.medicine || '',
        entry_id: f.entry_id,
        raw_epoch: parsed.epoch
      };
    }).filter(d => d.person && d.medicine);
    renderTable(fullData);
  });
}

function renderTable(data) {
  const table = document.getElementById('scheduleTable');
  table.innerHTML = '';
  data.forEach((d, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="datetime-local" value="${toDatetimeLocal(+d.raw_epoch * 1000)}" onchange="editField(${i}, 'time', this.value)"></td>
      <td><input value="${d.person}" onchange="editField(${i}, 'person', this.value)"></td>
      <td><input value="${d.medicine}" onchange="editField(${i}, 'medicine', this.value)"></td>
      <td class="actions">
        <button onclick="deleteEntry(${i})">üóëÔ∏è Delete</button>
      </td>`;
    table.appendChild(tr);
  });
}

// ===== Editing =====
function editField(index, field, value) {
  if (field === 'time') {
    fullData[index].raw_epoch = Math.floor(new Date(value).getTime() / 1000);
    fullData[index].time = new Date(fullData[index].raw_epoch * 1000).toLocaleString();
  } else {
    fullData[index][field] = value;
  }
}

// ===== Deletion (by overwriting field with empty string) =====
function deleteEntry(index) {
  if (!confirm("Delete this entry?")) return;
  const url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=`;
  fetch(url).then(() => {
    fullData.splice(index, 1);
    renderTable(fullData);
  });
}

// ===== Helpers =====
function filterTable() {
  const v = document.getElementById('searchInput').value.toLowerCase();
  const f = fullData.filter(d =>
    d.person.toLowerCase().includes(v) ||
    d.medicine.toLowerCase().includes(v) ||
    d.time.toLowerCase().includes(v));
  renderTable(f);
}
function exportExcel() {
  const data = [["Time", "Name", "Medicine"]];
  fullData.forEach(d => data.push([d.time, d.person, d.medicine]));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Schedule");
  XLSX.writeFile(wb, "Medicine_Schedule.xlsx");
}
function toDatetimeLocal(ts) {
  const d = new Date(ts);
  return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0,16);
}
function restartAutoRefresh() {
  clearInterval(timer);
  const sec = parseInt(document.getElementById('refreshTime').value);
  timer = setInterval(loadSchedule, sec * 1000);
}
window.onload = () => {
  loadSchedule();
  restartAutoRefresh();
};
</script>

</body>
</html>
