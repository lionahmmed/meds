<!DOCTYPE html>
<html>
<head>
  <title>Medicine Scheduler Dashboard</title>
  <style>
    body {
      font-family: Arial;
      margin: 30px;
    }
    label, input, button {
      font-size: 16px;
      margin: 5px 0;
    }
    input {
      padding: 6px;
      width: 250px;
    }
    button {
      padding: 8px 16px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    table {
      margin-top: 30px;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 15px;
    }
    th {
      background-color: #f0f0f0;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Medicine Schedule Uploader</h2>

  <label>Person Name:</label><br>
  <input type="text" id="person"><br>

  <label>Medicine:</label><br>
  <input type="text" id="medicine"><br>

  <label>Schedule Time:</label><br>
  <input type="datetime-local" id="schedule"><br>

  <button onclick="sendSchedule()">Submit</button>
  <p id="status"></p>

  <h2>Schedule Table</h2>
  <button onclick="loadSchedule()">üîÑ Refresh</button>
  <button onclick="exportCSV()">üì§ Export CSV</button>
  <table id="dataTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Schedule Time</th>
        <th onclick="sortTable(1)">Person Name</th>
        <th onclick="sortTable(2)">Medicine</th>
      </tr>
    </thead>
    <tbody id="scheduleTable"></tbody>
  </table>

  <script>
    const channelID = '1234567'; // Change to your ThingSpeak channel
    const readAPIKey = '';       // If private channel
    const writeAPIKey = 'ALB6HK9T805Q8WJQ'; // Replace with your Write API key

    function toAscii(str) {
      return str.split('').map(c => c.charCodeAt(0)).join('');
    }

    function sendSchedule() {
      const person = document.getElementById('person').value.trim();
      const medicine = document.getElementById('medicine').value.trim();
      const scheduleInput = document.getElementById('schedule').value;
      const status = document.getElementById('status');

      if (!person || !medicine || !scheduleInput) {
        status.textContent = "Please fill in all fields.";
        return;
      }

      const epoch = Math.floor(new Date(scheduleInput).getTime() / 1000);
      const personAscii = toAscii(person);
      const medicineAscii = toAscii(medicine);

      const tlv =
        `T01L10V${epoch}` +
        `T02L${personAscii.length}V${personAscii}` +
        `T03L${medicineAscii.length}V${medicineAscii}`;

      const url = `https://api.thingspeak.com/update?api_key=${writeAPIKey}&field1=${tlv}`;

      fetch(url)
        .then(res => res.text())
        .then(data => {
          status.textContent = parseInt(data) > 0 ? `‚úÖ Uploaded. Entry ID: ${data}` : '‚ùå Upload failed.';
          loadSchedule();
        })
        .catch(err => status.textContent = `‚ö†Ô∏è Error: ${err}`);
    }

    function decodeTLV(tlv) {
      const data = {};
      let i = 0;

      while (i < tlv.length) {
        const tag = tlv.substring(i, i + 3); i += 3;
        const lenIndex = tlv.indexOf('V', i);
        const length = parseInt(tlv.substring(i + 1, lenIndex)); // Lx part
        i = lenIndex + 1;
        const value = tlv.substring(i, i + length);
        i += length;

        if (tag === 'T01') data.epoch = value;
        else if (tag === 'T02') data.person = decodeAsciiDigits(value);
        else if (tag === 'T03') data.medicine = decodeAsciiDigits(value);
      }
      return data;
    }

    function decodeAsciiDigits(digits) {
      let result = "", i = 0;
      while (i < digits.length) {
        let code = parseInt(digits.substring(i, i + 3));
        if (code >= 32 && code <= 126) {
          result += String.fromCharCode(code);
          i += 3;
        } else {
          code = parseInt(digits.substring(i, i + 2));
          result += String.fromCharCode(code);
          i += 2;
        }
      }
      return result;
    }

    function loadSchedule() {
      const url = `https://api.thingspeak.com/channels/${channelID}/fields/1.json?results=50${readAPIKey ? '&api_key=' + readAPIKey : ''}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          const tbody = document.getElementById('scheduleTable');
          tbody.innerHTML = '';

          const rows = [];

          json.feeds.reverse().forEach(feed => {
            const tlv = feed.field1;
            if (!tlv || !tlv.startsWith("T01")) return;

            const data = decodeTLV(tlv);
            const date = new Date(parseInt(data.epoch) * 1000).toLocaleString();

            rows.push([date, data.person, data.medicine]);
          });

          for (const row of rows) {
            tbody.innerHTML += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td></tr>`;
          }
        });
    }

    function sortTable(colIndex) {
      const table = document.getElementById("dataTable");
      let switching = true;
      let shouldSwitch, i;
      let dir = "asc", switchCount = 0;

      while (switching) {
        switching = false;
        let rows = table.rows;

        for (i = 1; i < rows.length - 1; i++) {
          shouldSwitch = false;
          const x = rows[i].getElementsByTagName("TD")[colIndex];
          const y = rows[i + 1].getElementsByTagName("TD")[colIndex];

          if ((dir === "asc" && x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) ||
              (dir === "desc" && x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase())) {
            shouldSwitch = true;
            break;
          }
        }

        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchCount++;
        } else {
          if (switchCount === 0 && dir === "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    function exportCSV() {
      const rows = document.querySelectorAll("table tr");
      const csv = [];

      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = [];
        cols.forEach(col => rowData.push('"' + col.innerText.replace(/"/g, '""') + '"'));
        csv.push(rowData.join(","));
      });

      const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "schedule_data.csv";
      a.click();
    }

    window.onload = loadSchedule;
  </script>
</body>
</html>
