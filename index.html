<!DOCTYPE html>
<html>
<head>
  <title>Medicine Scheduler</title>
  <style>
    body {
      font-family: Arial;
      margin: 30px;
    }
    label, input, select, button {
      font-size: 16px;
      margin: 5px 0;
    }
    input, select {
      padding: 6px;
      width: 250px;
    }
    button {
      padding: 8px 16px;
    }
    table {
      margin-top: 30px;
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <h2>Medicine Schedule Uploader</h2>

  <label>Person Name:</label><br>
  <input type="text" id="person"><br>

  <label>Medicine:</label><br>
  <input type="text" id="medicine"><br>

  <label>Schedule Time:</label><br>
  <input type="datetime-local" id="schedule"><br>

  <label>Recurrence:</label><br>
  <select id="recurrence">
    <option value="01">Everyday</option>
    <option value="02">Every 2 Days</option>
    <option value="03">Every 3 Days</option>
    <option value="04">Weekly</option>
    <option value="00">One-Time</option>
  </select><br>

  <button onclick="sendSchedule()">Submit</button>
  <p id="status"></p>

  <h3>Uploaded Schedules</h3>
  <table id="scheduleTable">
    <thead>
      <tr>
        <th>Schedule Time</th>
        <th>Person Name</th>
        <th>Medicine</th>
        <th>Recurrence</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiKey = 'ALB6HK9T805Q8WJQ';
    const channelId = '3008675'; // Replace with your ThingSpeak channel ID

    function asciiEncode(str) {
      return Array.from(str)
        .map(c => c.charCodeAt(0).toString().padStart(3, '0'))
        .join('');
    }

    function buildTLV(epoch, name, med, recurrence) {
      const nameEncoded = asciiEncode(name);
      const medEncoded = asciiEncode(med);

      const tlv =
        '01' + epoch.toString().length.toString().padStart(2, '0') + epoch +
        '02' + nameEncoded.length.toString().padStart(2, '0') + nameEncoded +
        '03' + medEncoded.length.toString().padStart(2, '0') + medEncoded +
        '04' + recurrence.length.toString().padStart(2, '0') + recurrence;

      return tlv;
    }

    function sendSchedule() {
      const person = document.getElementById('person').value.trim();
      const medicine = document.getElementById('medicine').value.trim();
      const scheduleInput = document.getElementById('schedule').value;
      const recurrence = document.getElementById('recurrence').value;
      const status = document.getElementById('status');

      if (!person || !medicine || !scheduleInput) {
        status.textContent = "Please fill in all fields.";
        return;
      }

      const epoch = Math.floor(new Date(scheduleInput).getTime() / 1000);
      const tlv = buildTLV(epoch, person, medicine, recurrence);

      const url = `https://api.thingspeak.com/update?api_key=${apiKey}&field1=${tlv}`;
      fetch(url)
        .then(res => res.text())
        .then(data => {
          if (parseInt(data) > 0) {
            status.textContent = "Schedule uploaded!";
            fetchSchedules(); // refresh table
          } else {
            status.textContent = "Upload failed. Try again.";
          }
        })
        .catch(err => status.textContent = "Error: " + err);
    }

    function decodeTLV(tlv) {
      const tagMap = {};
      let i = 0;

      while (i < tlv.length) {
        const tag = tlv.substr(i, 2);
        const len = parseInt(tlv.substr(i + 2, 2));
        const val = tlv.substr(i + 4, len);
        tagMap[tag] = val;
        i += 4 + len;
      }

      return tagMap;
    }

    function asciiDecode(str) {
      let result = '';
      for (let i = 0; i < str.length; i += 3) {
        result += String.fromCharCode(parseInt(str.substr(i, 3)));
      }
      return result;
    }

    function recurrenceLabel(code) {
      const map = {
        '01': 'Everyday',
        '02': 'Every 2 Days',
        '03': 'Every 3 Days',
        '04': 'Weekly',
        '00': 'One-Time'
      };
      return map[code] || 'Unknown';
    }

    function fetchSchedules() {
      const url = `https://api.thingspeak.com/channels/${channelId}/fields/1.json?results=20`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const tableBody = document.querySelector("#scheduleTable tbody");
          tableBody.innerHTML = "";

          data.feeds.forEach(feed => {
            if (!feed.field1) return;
            const tlv = decodeTLV(feed.field1);
            const time = new Date(parseInt(tlv["01"]) * 1000).toLocaleString();
            const name = asciiDecode(tlv["02"] || '');
            const med = asciiDecode(tlv["03"] || '');
            const recurrence = recurrenceLabel(tlv["04"] || '00');

            const row = document.createElement("tr");
            row.innerHTML = `<td>${time}</td><td>${name}</td><td>${med}</td><td>${recurrence}</td>`;
            tableBody.appendChild(row);
          });
        });
    }

    fetchSchedules(); // initial fetch
    setInterval(fetchSchedules, 15000); // refresh every 15 seconds
  </script>

</body>
</html>
